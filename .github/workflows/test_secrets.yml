name: Test Secrets Configuration

# This is a diagnostic workflow to help identify why ALKiln tests are failing
# It will help determine if the secrets are properly configured

on:
  workflow_dispatch:  # Manual trigger only
  pull_request:
    branches: [main, master]

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Verify Secrets Are Accessible
    steps:
      - name: Check if SERVER_URL is set
        run: |
          if [ -z "${{ secrets.SERVER_URL }}" ]; then
            echo "❌ ERROR: SERVER_URL secret is NOT set or is empty"
            echo "Please go to Settings → Secrets and variables → Actions"
            echo "and add a secret named: SERVER_URL"
            exit 1
          else
            echo "✅ SERVER_URL secret is set"
            echo "Length: ${#SERVER_URL}"
            echo "First 10 chars: ${SERVER_URL:0:10}..."
          fi
        env:
          SERVER_URL: ${{ secrets.SERVER_URL }}
      
      - name: Check if DOCASSEMBLE_DEVELOPER_API_KEY is set
        run: |
          if [ -z "${{ secrets.DOCASSEMBLE_DEVELOPER_API_KEY }}" ]; then
            echo "❌ ERROR: DOCASSEMBLE_DEVELOPER_API_KEY secret is NOT set or is empty"
            echo "Please go to Settings → Secrets and variables → Actions"
            echo "and add a secret named: DOCASSEMBLE_DEVELOPER_API_KEY"
            exit 1
          else
            echo "✅ DOCASSEMBLE_DEVELOPER_API_KEY secret is set"
            echo "Length: ${#API_KEY}"
          fi
        env:
          API_KEY: ${{ secrets.DOCASSEMBLE_DEVELOPER_API_KEY }}
      
      - name: Validate SERVER_URL format
        run: |
          if [[ ! "$SERVER_URL" =~ ^https?:// ]]; then
            echo "❌ WARNING: SERVER_URL does not start with http:// or https://"
            echo "Current value starts with: ${SERVER_URL:0:10}..."
          fi
          
          if [[ ! "$SERVER_URL" =~ :443/$ ]]; then
            echo "⚠️  WARNING: SERVER_URL should end with :443/"
            echo "Current value ends with: ...${SERVER_URL: -10}"
          fi
          
          echo "✅ Basic format checks complete"
        env:
          SERVER_URL: ${{ secrets.SERVER_URL }}
      
      - name: Summary
        run: |
          echo ""
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Secret Configuration Summary"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "If both secrets show as ✅ above, the secrets are configured correctly."
          echo "The ALKiln test failure might be due to:"
          echo "  1. Incorrect SERVER_URL or API_KEY values"
          echo "  2. Server is down or unreachable"
          echo "  3. API key is invalid or expired"
          echo ""
          echo "Next steps:"
          echo "  - Test SERVER_URL in browser to confirm it's accessible"
          echo "  - Verify API key is active in your docassemble server"
          echo "  - Check server logs for connection attempts"
          echo ""
